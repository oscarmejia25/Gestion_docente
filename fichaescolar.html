<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ficha Escolar</title>
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #1a56db;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    /* Pestañas */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      background-color: #e0e7ff;
      color: #1a56db;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      flex: 1;
      min-width: 150px;
    }

    .tab-btn.active {
      background-color: #1a56db;
      color: white;
    }

    /* Secciones */
    .section {
      display: none;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      animation: fadeIn 0.4s ease-in-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Formulario */
    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #1a56db;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    textarea {
      resize: vertical;
    }

    /* Botones */
    button {
      padding: 10px 18px;
      background-color: #1a56db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background-color: #0d3b9d;
    }

    button.btn-secondary {
      background-color: #6c757d;
    }

    button.btn-secondary:hover {
      background-color: #545b62;
    }

    button.btn-danger {
      background-color: #dc3545;
    }

    button.btn-danger:hover {
      background-color: #c82333;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    /* Mensajes */
    .alert {
      padding: 12px;
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      margin: 15px 0;
    }

    /* Lista de fichas desplegable */
    .ficha-dropdown {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-left: 4px solid #1a56db;
      border-radius: 5px;
    }

    .ficha-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .ficha-item p {
      margin: 4px 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .tab-btn {
        font-size: 0.95rem;
        padding: 10px 16px;
      }

      .actions {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Ficha Escolar | Centro Escolar Cantón Los Prados</h1>

    <!-- Pestañas -->
    <div class="tabs">
      <button class="tab-btn active" id="tab-ficha">Ficha Escolar</button>
      <button class="tab-btn" id="tab-consolidado">Consolidado</button>
    </div>

    <!-- Sección Ficha Escolar -->
    <div id="ficha-section" class="section active">
      <div class="form-group">
        <label for="nie">NIE del Estudiante:</label>
        <input type="text" id="nie" placeholder="Ej: 123456789" />
      </div>
      <button id="verificar-btn"><i class="fas fa-search"></i> Verificar</button>

      <div id="resultado-verificacion"></div>

      <!-- Formulario Crear Estudiante -->
      <div id="crear-estudiante-form" class="hidden">
        <h3 style="color: #1a56db; margin-top: 20px;">Registrar Nuevo Estudiante</h3>
        <div class="form-group">
          <label for="centro-escolar">Nombre del Centro Escolar:</label>
          <input type="text" id="centro-escolar" required />
        </div>
        <div class="form-group">
          <label for="nombre-estudiante">Nombre del Estudiante:</label>
          <input type="text" id="nombre-estudiante" required />
        </div>
        <div class="form-group">
          <label for="grado">Grado:</label>
          <select id="grado" required>
            <option value="">Seleccionar grado</option>
            <option value="Parvularia 4">Parvularia 4</option>
            <option value="Parvularia 5">Parvularia 5</option>
            <option value="Parvularia 6">Parvularia 6</option>
            <option value="1ro">1ro</option>
            <option value="2do">2do</option>
            <option value="3ro">3ro</option>
            <option value="4to">4to</option>
            <option value="5to">5to</option>
            <option value="6to">6to</option>
            <option value="7mo">7mo</option>
            <option value="8vo">8vo</option>
            <option value="9no">9no</option>
          </select>
        </div>
        <div class="form-group">
          <label for="responsable">Nombre del Responsable:</label>
          <input type="text" id="responsable" required />
        </div>
        <div class="form-group">
          <label for="docente">Docente Responsable:</label>
          <input type="text" id="docente" required />
        </div>
        <div class="actions">
          <button id="guardar-estudiante-btn">Guardar</button>
          <button id="cancelar-estudiante-btn" class="btn-secondary">Cancelar</button>
        </div>
      </div>

      <!-- Formulario Ficha Escolar -->
      <div id="ficha-form" class="hidden">
        <h3 style="color: #1a56db; margin-top: 20px;">Registrar Ficha Escolar</h3>
        <div class="form-group">
          <label for="ficha-centro">Centro Escolar:</label>
          <input type="text" id="ficha-centro" readonly />
        </div>
        <div class="form-group">
          <label for="ficha-nombre">Nombre del Estudiante:</label>
          <input type="text" id="ficha-nombre" readonly />
        </div>
        <div class="form-group">
          <label for="ficha-nie">NIE:</label>
          <input type="text" id="ficha-nie" readonly />
        </div>
        <div class="form-group">
          <label for="ficha-grado">Grado:</label>
          <input type="text" id="ficha-grado" readonly />
        </div>
        <div class="form-group">
          <label for="ficha-fecha">Fecha:</label>
          <input type="date" id="ficha-fecha" required />
        </div>
        <div class="form-group">
          <label for="ficha-hora">Hora:</label>
          <input type="time" id="ficha-hora" required />
        </div>
        <div class="form-group">
          <label for="ficha-tipo">Tipo de Falta:</label>
          <select id="ficha-tipo" required>
            <option value="">Seleccionar</option>
            <option value="Académica">Académica</option>
            <option value="Conductual">Conductual</option>
            <option value="Puntualidad">Puntualidad</option>
            <option value="Otra">Otra</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ficha-descripcion">Descripción de la Falta:</label>
          <textarea id="ficha-descripcion" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="ficha-accion">Acción Tomada:</label>
          <textarea id="ficha-accion" rows="2" required></textarea>
        </div>
        <div class="form-group">
          <label for="ficha-responsable">Responsable:</label>
          <input type="text" id="ficha-responsable" readonly />
        </div>
        <div class="form-group">
          <label for="ficha-docente">Docente Responsable:</label>
          <input type="text" id="ficha-docente" readonly />
        </div>
        <div class="actions">
          <button id="finalizar-ficha-btn">Finalizar</button>
          <button id="cancelar-ficha-btn" class="btn-secondary">Cancelar</button>
        </div>
      </div>

      <!-- Botones finales -->
      <div id="botones-finales" class="hidden" style="margin-top: 20px;">
        <div class="actions">
          <button id="descargar-pdf-btn"><i class="fas fa-download"></i> Descargar PDF</button>
          <button id="nueva-ficha-btn" class="btn-secondary">Nueva Ficha</button>
        </div>
      </div>
    </div>

    <!-- Sección Consolidado -->
    <div id="consolidado-section" class="section">
      <h2 style="color: #1a56db;">Consolidado de Estudiantes</h2>
      <div id="lista-estudiantes">
        <p>Cargando estudiantes...</p>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    // Importar Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbSKiGM7QDIRFuGJlE1vQr-CLRUr4jj1g",
      authDomain: "ficha-escolar-864be.firebaseapp.com",
      projectId: "ficha-escolar-864be",
      storageBucket: "ficha-escolar-864be.firebasestorage.app",
      messagingSenderId: "994495539253",
      appId: "1:994495539253:web:f3cff16ada007496daa97c",
      measurementId: "G-M5XHSJ3S73"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elementos DOM
    const tabFicha = document.getElementById("tab-ficha");
    const tabConsolidado = document.getElementById("tab-consolidado");
    const seccionFicha = document.getElementById("ficha-section");
    const seccionConsolidado = document.getElementById("consolidado-section");

    const nieInput = document.getElementById("nie");
    const verificarBtn = document.getElementById("verificar-btn");
    const resultadoDiv = document.getElementById("resultado-verificacion");

    const crearEstudianteForm = document.getElementById("crear-estudiante-form");
    const fichaForm = document.getElementById("ficha-form");
    const botonesFinales = document.getElementById("botones-finales");

    const guardarEstudianteBtn = document.getElementById("guardar-estudiante-btn");
    const cancelarEstudianteBtn = document.getElementById("cancelar-estudiante-btn");
    const finalizarFichaBtn = document.getElementById("finalizar-ficha-btn");
    const cancelarFichaBtn = document.getElementById("cancelar-ficha-btn");
    const descargarPdfBtn = document.getElementById("descargar-pdf-btn");
    const nuevaFichaBtn = document.getElementById("nueva-ficha-btn");

    // Variables globales
    let currentStudent = null;

    // Cambiar pestañas
    tabFicha.addEventListener("click", () => {
      tabFicha.classList.add("active");
      tabConsolidado.classList.remove("active");
      seccionFicha.classList.add("active");
      seccionConsolidado.classList.remove("active");
    });

    tabConsolidado.addEventListener("click", () => {
      tabConsolidado.classList.add("active");
      tabFicha.classList.remove("active");
      seccionConsolidado.classList.add("active");
      seccionFicha.classList.remove("active");
      loadConsolidado();
    });

    // Verificar NIE
    verificarBtn.addEventListener("click", async () => {
      const nie = nieInput.value.trim();
      if (!nie) return alert("Por favor ingrese un NIE.");

      resultadoDiv.innerHTML = "";
      crearEstudianteForm.classList.add("hidden");
      fichaForm.classList.add("hidden");
      botonesFinales.classList.add("hidden");

      const studentRef = doc(db, "students", nie);
      const studentSnap = await getDoc(studentRef);

      if (studentSnap.exists()) {
        currentStudent = { ...studentSnap.data(), id: nie };
        mostrarOpcionesExistentes(nie);
      } else {
        resultadoDiv.innerHTML = '<div class="alert">No existe un estudiante registrado con ese NIE.</div>';
        crearEstudianteForm.classList.remove("hidden");
      }
    });

    // Mostrar opciones si existe
    function mostrarOpcionesExistentes(nie) {
      resultadoDiv.innerHTML = `
        <p><strong>¿Qué deseas hacer?</strong></p>
        <div class="actions">
          <button id="btn-ficha-existente">Ficha Escolar</button>
          <button id="btn-editar-estudiante" class="btn-secondary">Editar</button>
        </div>
      `;
      document.getElementById("btn-ficha-existente").addEventListener("click", () => abrirFichaForm());
      document.getElementById("btn-editar-estudiante").addEventListener("click", () => editarEstudiante());
    }

    // Abrir formulario de ficha
    function abrirFichaForm() {
      const data = currentStudent;
      document.getElementById("ficha-centro").value = data.centroEscolar || "";
      document.getElementById("ficha-nombre").value = data.nombre;
      document.getElementById("ficha-nie").value = data.nie;
      document.getElementById("ficha-grado").value = data.grado;
      document.getElementById("ficha-responsable").value = data.responsable;
      document.getElementById("ficha-docente").value = data.docente;

      document.getElementById("ficha-fecha").value = new Date().toISOString().split('T')[0];
      document.getElementById("ficha-hora").value = new Date().toTimeString().slice(0, 5);

      fichaForm.classList.remove("hidden");
    }

    // Editar estudiante
    function editarEstudiante() {
      const data = currentStudent;
      document.getElementById("centro-escolar").value = data.centroEscolar || "";
      document.getElementById("nombre-estudiante").value = data.nombre;
      document.getElementById("grado").value = data.grado;
      document.getElementById("responsable").value = data.responsable;
      document.getElementById("docente").value = data.docente;

      crearEstudianteForm.classList.remove("hidden");
      resultadoDiv.innerHTML = '<p><strong>Editando información del estudiante.</strong></p>';
    }

    // Guardar nuevo estudiante
    guardarEstudianteBtn.addEventListener("click", async () => {
      const nie = nieInput.value.trim();
      const centro = document.getElementById("centro-escolar").value;
      const nombre = document.getElementById("nombre-estudiante").value;
      const grado = document.getElementById("grado").value;
      const responsable = document.getElementById("responsable").value;
      const docente = document.getElementById("docente").value;

      if (!nombre || !grado || !responsable || !docente) {
        alert("Por favor complete todos los campos.");
        return;
      }

      const studentData = {
        centroEscolar: centro,
        nombre,
        grado,
        responsable,
        docente,
        nie,
        fichas: 0
      };

      await setDoc(doc(db, "students", nie), studentData);
      currentStudent = studentData;

      crearEstudianteForm.classList.add("hidden");
      abrirFichaForm();
    });

    // Cancelar creación
    cancelarEstudianteBtn.addEventListener("click", () => {
      crearEstudianteForm.classList.add("hidden");
      resultadoDiv.innerHTML = "";
    });

    // Finalizar ficha
    finalizarFichaBtn.addEventListener("click", async () => {
      const nie = document.getElementById("ficha-nie").value;
      const data = {
        centroEscolar: document.getElementById("ficha-centro").value,
        nombre: document.getElementById("ficha-nombre").value,
        nie,
        grado: document.getElementById("ficha-grado").value,
        fecha: document.getElementById("ficha-fecha").value,
        hora: document.getElementById("ficha-hora").value,
        tipoFalta: document.getElementById("ficha-tipo").value,
        descripcion: document.getElementById("ficha-descripcion").value,
        accion: document.getElementById("ficha-accion").value,
        responsable: document.getElementById("ficha-responsable").value,
        docente: document.getElementById("ficha-docente").value,
        createdAt: new Date().toISOString()
      };

      await addDoc(collection(db, "fichas"), data);

      const studentRef = doc(db, "students", nie);
      await updateDoc(studentRef, { fichas: currentStudent.fichas + 1 });
      currentStudent.fichas += 1;

      fichaForm.classList.add("hidden");
      botonesFinales.classList.remove("hidden");
    });

    cancelarFichaBtn.addEventListener("click", () => {
      fichaForm.classList.add("hidden");
    });

    // Descargar PDF
    descargarPdfBtn.addEventListener("click", () => {
      generatePDF({
        centro: document.getElementById("ficha-centro").value,
        nombre: document.getElementById("ficha-nombre").value,
        nie: document.getElementById("ficha-nie").value,
        grado: document.getElementById("ficha-grado").value,
        fecha: document.getElementById("ficha-fecha").value,
        hora: document.getElementById("ficha-hora").value,
        tipo: document.getElementById("ficha-tipo").value,
        descripcion: document.getElementById("ficha-descripcion").value,
        accion: document.getElementById("ficha-accion").value,
        responsable: document.getElementById("ficha-responsable").value,
        docente: document.getElementById("ficha-docente").value,
        fichas: currentStudent.fichas + 1
      });
    });

    // Nueva ficha
    nuevaFichaBtn.addEventListener("click", () => {
      location.reload();
    });

    // Generar PDF (horizontal)
    function generatePDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

      doc.setFontSize(16);
      doc.text("FICHA ESCOLAR", 10, 20);
      doc.setFontSize(12);
      doc.text("CENTRO ESCOLAR CANTÓN LOS PRADOS", 10, 30);

      const y = 40;
      doc.text(`Nombre del Estudiante: ${data.nombre}`, 10, y);
      doc.text(`Centro Escolar: ${data.centro}`, 100, y);
      doc.text(`NIE: ${data.nie}`, 10, y + 10);
      doc.text(`Grado: ${data.grado}`, 100, y + 10);
      doc.text(`Fecha: ${data.fecha} Hora: ${data.hora}`, 10, y + 20);
      doc.text(`Tipo de Falta: ${data.tipo}`, 10, y + 30);
      doc.text(`Descripción: ${data.descripcion}`, 10, y + 40);
      doc.text(`Acción tomada: ${data.accion}`, 10, y + 50);
      doc.text(`Fichas acumuladas: ${data.fichas}`, 10, y + 60);

      doc.text("Firma del Estudiante: _______________________", 10, y + 80);
      doc.text("Firma del Responsable: ______________________", 10, y + 95);
      doc.text("Firma del Docente: __________________________", 100, y + 95);

      doc.save(`ficha_${data.nombre.replace(/\s+/g, '_')}_${data.fecha}.pdf`);
    }

    // Cargar Consolidado
    async function loadConsolidado() {
      const div = document.getElementById("lista-estudiantes");
      div.innerHTML = "<p>Cargando estudiantes...</p>";

      try {
        const querySnapshot = await getDocs(collection(db, "students"));
        const estudiantes = [];
        querySnapshot.forEach(doc => {
          estudiantes.push({ id: doc.id, ...doc.data() });
        });

        div.innerHTML = "";
        if (estudiantes.length === 0) {
          div.innerHTML = "<p>No hay estudiantes registrados.</p>";
          return;
        }

        estudiantes.sort((a, b) => a.nombre.localeCompare(b.nombre));

        estudiantes.forEach(est => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `<strong>${est.nombre}</strong> - Fichas: ${est.fichas || 0}`;
          card.style.cursor = "pointer";
          card.onclick = () => toggleFichas(est.id);
          div.appendChild(card);
        });
      } catch (error) {
        div.innerHTML = `<p>Error: ${error.message}</p>`;
      }
    }

    // Toggle fichas
    async function toggleFichas(nie) {
      const card = event.target.closest(".card");
      const dropdown = card.querySelector(".ficha-dropdown");
      if (dropdown) {
        dropdown.remove();
        return;
      }

      const container = document.createElement("div");
      container.className = "ficha-dropdown";
      card.appendChild(container);

      try {
        const querySnapshot = await getDocs(collection(db, "fichas").where("nie", "==", nie));
        if (querySnapshot.empty) {
          container.innerHTML = "<p>No tiene fichas registradas.</p>";
          return;
        }

        querySnapshot.forEach(doc => {
          const f = doc.data();
          const item = document.createElement("div");
          item.className = "ficha-item";
          item.innerHTML = `
            <p><strong>Fecha:</strong> ${f.fecha} | <strong>Hora:</strong> ${f.hora}</p>
            <p><strong>Tipo:</strong> ${f.tipoFalta}</p>
            <p><strong>Descripción:</strong> ${f.descripcion}</p>
            <p><strong>Acción:</strong> ${f.accion}</p>
            <div class="actions">
              <button class="btn-pdf" onclick="generatePDFFromConsolidado(${JSON.stringify(f).replace(/"/g, '&quot;')})">Descargar PDF</button>
              <button class="btn-danger" onclick="eliminarFicha('${doc.id}')">Eliminar</button>
            </div>
          `;
          container.appendChild(item);
        });
      } catch (error) {
        container.innerHTML = `<p>Error: ${error.message}</p>`;
      }
    }

    // Funciones globales
    window.generatePDFFromConsolidado = function(fichaData) {
      generatePDF({
        centro: fichaData.centroEscolar || "No especificado",
        nombre: fichaData.nombre,
        nie: fichaData.nie,
        grado: fichaData.grado,
        fecha: fichaData.fecha,
        hora: fichaData.hora,
        tipo: fichaData.tipoFalta,
        descripcion: fichaData.descripcion,
        accion: fichaData.accion,
        responsable: fichaData.responsable,
        docente: fichaData.docente,
        fichas: 1 // Temporal
      });
    };

    window.eliminarFicha = async function(id) {
      if (confirm("¿Seguro que deseas eliminar esta ficha?")) {
        await deleteDoc(doc(db, "fichas", id));
        alert("Ficha eliminada.");
        location.reload();
      }
    };

    // Cargar jsPDF
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
    script.onload = () => console.log("jsPDF cargado");
    document.head.appendChild(script);
  </script>
</body>
</html>
