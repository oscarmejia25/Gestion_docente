<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ficha Escolar | Centro Escolar Cantón Los Prados</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Arial', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #1a56db;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    p.subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-style: italic;
    }

    /* Pestañas */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 24px;
      background-color: #e0e7ff;
      color: #1a56db;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
      flex: 1;
      min-width: 150px;
    }

    .tab-btn.active {
      background-color: #1a56db;
      color: white;
    }

    /* Secciones */
    .section {
      display: none;
      padding: 25px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      animation: fadeIn 0.4s ease-in-out;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Formulario */
    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #1a56db;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .radio-group label {
      font-weight: normal;
      display: flex;
      align-items: center;
    }

    /* Botones */
    button {
      padding: 10px 18px;
      background-color: #1a56db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background-color: #0d3b9d;
    }

    button.btn-secondary {
      background-color: #6c757d;
    }

    button.btn-secondary:hover {
      background-color: #545b62;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    /* Tabla en consolidado */
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .table th, .table td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .table th {
      background-color: #1a56db;
      color: white;
      font-weight: bold;
    }

    .table tr:hover {
      background-color: #f0f5ff;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .tab-btn {
        font-size: 0.95rem;
        padding: 10px 16px;
      }

      .actions {
        flex-direction: column;
      }

      button {
        width: 100%;
        text-align: center;
      }

      .radio-group {
        flex-direction: column;
      }
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .hidden {
      display: none !important;
    }

    .pdf-container {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border: 1px dashed #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Ficha Escolar</h1>
    <p class="subtitle">Centro Escolar Cantón Los Prados</p>

    <!-- Pestañas -->
    <div class="tabs">
      <button class="tab-btn active" id="tab-ficha">Ficha Escolar</button>
      <button class="tab-btn" id="tab-consolidado">Consolidado</button>
    </div>

    <!-- Sección Ficha Escolar -->
    <div id="ficha-section" class="section active">
      <h2 style="color: #1a56db; margin-bottom: 20px;">Registro de Ficha</h2>
      <div class="form-group">
        <label for="nie">NIE del Estudiante:</label>
        <input type="text" id="nie" placeholder="Ej: 123456789" />
      </div>
      <button id="verificar-btn"><i class="fas fa-search"></i> Verificar</button>

      <!-- Opciones si no existe -->
      <div id="opciones-student" class="hidden" style="margin-top: 20px;">
        <button id="crear-ficha-btn">Crear ficha con nuevo registro</button>
      </div>

      <!-- Opciones si existe -->
      <div id="acciones-existente" class="hidden" style="margin-top: 20px;">
        <p><strong>¿Qué quieres hacer?</strong></p>
        <div class="actions">
          <button id="editar-info-btn">Editar información</button>
          <button id="agregar-ficha-btn">Agregar ficha</button>
        </div>
      </div>

      <!-- Formulario Nuevo Estudiante -->
      <div id="nuevo-estudiante-form" class="hidden">
        <h3 style="color: #1a56db;">Datos del Estudiante</h3>
        <div class="form-group">
          <label for="nombre">Nombre:</label>
          <input type="text" id="nombre" required />
        </div>
        <div class="form-group">
          <label for="grado">Grado:</label>
          <select id="grado" required>
            <option value="">Seleccionar grado</option>
            <option value="1ro">1ro</option>
            <option value="2do">2do</option>
            <option value="3ro">3ro</option>
            <option value="4to">4to</option>
            <option value="5to">5to</option>
            <option value="6to">6to</option>
          </select>
        </div>
        <div class="form-group">
          <label for="docente">Docente:</label>
          <input type="text" id="docente" required />
        </div>
        <div class="form-group">
          <label for="responsable">Responsable:</label>
          <input type="text" id="responsable" required />
        </div>
        <div class="actions">
          <button id="finalizar-registro-btn">Finalizar Registro</button>
          <button id="cancelar-registro-btn" class="btn-secondary">Cancelar</button>
        </div>
      </div>

      <!-- Formulario Agregar Ficha -->
      <div id="agregar-ficha-form" class="hidden">
        <h3 style="color: #1a56db;">Agregar Ficha</h3>
        <div class="form-group">
          <label for="fecha">Fecha:</label>
          <input type="date" id="fecha" required />
        </div>
        <div class="form-group">
          <label for="hora">Hora:</label>
          <input type="time" id="hora" required />
        </div>
        <div class="form-group">
          <label>Tipo de Falta:</label>
          <div class="radio-group">
            <label><input type="radio" name="tipo-falta" value="Académica"> Académica</label>
            <label><input type="radio" name="tipo-falta" value="Conducta"> Conducta</label>
            <label><input type="radio" name="tipo-falta" value="Puntualidad"> Puntualidad</label>
            <label><input type="radio" name="tipo-falta" value="Otra"> Otra:</label>
            <input type="text" id="otra-falta" placeholder="Especificar" style="width: 150px;" />
          </div>
        </div>
        <div class="form-group">
          <label for="descripcion">Descripción de la Falta:</label>
          <textarea id="descripcion" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="accion">Acción tomada:</label>
          <textarea id="accion" rows="2" required></textarea>
        </div>
        <div class="actions">
          <button id="finalizar-ficha-btn">Registrar Ficha</button>
          <button id="cancelar-ficha-btn" class="btn-secondary">Cancelar</button>
        </div>
      </div>

      <!-- Botón Descargar Ficha -->
      <div id="descargar-ficha-btn-container" class="hidden" style="margin-top: 20px;">
        <button id="descargar-ficha-btn"><i class="fas fa-download"></i> Descargar Ficha</button>
      </div>
    </div>

    <!-- Sección Consolidado -->
    <div id="consolidado-section" class="section">
      <h2 style="color: #1a56db; margin-bottom: 20px;">Consolidado de Fichas</h2>
      <div id="lista-estudiantes">
        <p>Cargando estudiantes...</p>
      </div>
    </div>
  </div>

  <!-- Modal Confirmación -->
  <div id="confirm-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Confirmar</h3>
      <p>¿Quieres registrar al estudiante y crear la ficha?</p>
      <div class="actions">
        <button id="confirm-yes">Sí</button>
        <button id="confirm-no" class="btn-secondary">No</button>
      </div>
    </div>
  </div>

  <!-- Incluir Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbSKiGM7QDIRFuGJlE1vQr-CLRUr4jj1g",
      authDomain: "ficha-escolar-864be.firebaseapp.com",
      projectId: "ficha-escolar-864be",
      storageBucket: "ficha-escolar-864be.firebasestorage.app",
      messagingSenderId: "994495539253",
      appId: "1:994495539253:web:f3cff16ada007496daa97c",
      measurementId: "G-M5XHSJ3S73"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elementos DOM
    const tabFicha = document.getElementById("tab-ficha");
    const tabConsolidado = document.getElementById("tab-consolidado");
    const seccionFicha = document.getElementById("ficha-section");
    const seccionConsolidado = document.getElementById("consolidado-section");

    const nieInput = document.getElementById("nie");
    const verificarBtn = document.getElementById("verificar-btn");
    const opcionesStudent = document.getElementById("opciones-student");
    const accionesExistente = document.getElementById("acciones-existente");
    const nuevoEstudianteForm = document.getElementById("nuevo-estudiante-form");
    const agregarFichaForm = document.getElementById("agregar-ficha-form");
    const descargarFichaBtnContainer = document.getElementById("descargar-ficha-btn-container");

    const crearFichaBtn = document.getElementById("crear-ficha-btn");
    const editarInfoBtn = document.getElementById("editar-info-btn");
    const agregarFichaBtn = document.getElementById("agregar-ficha-btn");
    const finalizarRegistroBtn = document.getElementById("finalizar-registro-btn");
    const cancelarRegistroBtn = document.getElementById("cancelar-registro-btn");
    const finalizarFichaBtn = document.getElementById("finalizar-ficha-btn");
    const cancelarFichaBtn = document.getElementById("cancelar-ficha-btn");
    const descargarFichaBtn = document.getElementById("descargar-ficha-btn");

    const confirmModal = document.getElementById("confirm-modal");
    const confirmYesBtn = document.getElementById("confirm-yes");
    const confirmNoBtn = document.getElementById("confirm-no");

    // Variables globales
    let currentStudent = null;

    // Cambiar pestañas
    tabFicha.addEventListener("click", () => {
      tabFicha.classList.add("active");
      tabConsolidado.classList.remove("active");
      seccionFicha.classList.add("active");
      seccionConsolidado.classList.remove("active");
    });

    tabConsolidado.addEventListener("click", () => {
      tabConsolidado.classList.add("active");
      tabFicha.classList.remove("active");
      seccionConsolidado.classList.add("active");
      seccionFicha.classList.remove("active");
      loadConsolidado();
    });

    // Verificar NIE
    verificarBtn.addEventListener("click", async () => {
      const nie = nieInput.value.trim();
      if (!nie) return alert("Por favor ingrese un NIE.");

      const studentRef = doc(db, "students", nie);
      const studentSnap = await getDoc(studentRef);

      resetForms();

      if (studentSnap.exists()) {
        currentStudent = { ...studentSnap.data(), id: nie };
        accionesExistente.classList.remove("hidden");
        opcionesStudent.classList.add("hidden");
      } else {
        currentStudent = null;
        opcionesStudent.classList.remove("hidden");
        accionesExistente.classList.add("hidden");
      }
    });

    // Mostrar formularios
    crearFichaBtn.addEventListener("click", () => {
      nuevoEstudianteForm.classList.remove("hidden");
    });

    agregarFichaBtn.addEventListener("click", () => {
      agregarFichaForm.classList.remove("hidden");
      // Llenar datos no editables
      document.getElementById("fecha").value = new Date().toISOString().split('T')[0];
      document.getElementById("hora").value = new Date().toTimeString().slice(0, 5);
    });

    // Finalizar nuevo registro
    finalizarRegistroBtn.addEventListener("click", () => {
      confirmModal.classList.remove("hidden");
    });

    confirmYesBtn.addEventListener("click", async () => {
      const nie = nieInput.value.trim();
      const nombre = document.getElementById("nombre").value;
      const grado = document.getElementById("grado").value;
      const docente = document.getElementById("docente").value;
      const responsable = document.getElementById("responsable").value;

      if (!nombre || !grado || !docente || !responsable) {
        alert("Por favor complete todos los campos.");
        return;
      }

      const studentData = { nombre, grado, docente, responsable, fichas: 1, nie };
      await addDoc(collection(db, "students"), studentData);

      const fichaData = {
        nie,
        estudiante: nombre,
        fecha: new Date().toISOString().split('T')[0],
        hora: new Date().toTimeString().slice(0, 5),
        tipoFalta: "Académica",
        descripcion: "Primera falta registrada",
        accion: "Notificación",
        createdAt: new Date().toISOString()
      };
      await addDoc(collection(db, "fichas"), fichaData);

      alert("Estudiante y ficha registrados exitosamente.");
      currentStudent = studentData;
      confirmModal.classList.add("hidden");
      showDownloadButton();
    });

    confirmNoBtn.addEventListener("click", () => {
      confirmModal.classList.add("hidden");
    });

    // Finalizar ficha existente
    finalizarFichaBtn.addEventListener("click", async () => {
      const nie = nieInput.value.trim();
      const fecha = document.getElementById("fecha").value;
      const hora = document.getElementById("hora").value;
      const tipoFalta = document.querySelector('input[name="tipo-falta"]:checked')?.value || "";
      const otraFalta = document.getElementById("otra-falta").value;
      const descripcion = document.getElementById("descripcion").value;
      const accion = document.getElementById("accion").value;

      if (!tipoFalta || !descripcion || !accion) {
        alert("Por favor complete todos los campos.");
        return;
      }

      const tipoFinal = otraFalta ? `${tipoFalta} (${otraFalta})` : tipoFalta;

      const fichaData = { nie, estudiante: currentStudent.nombre, fecha, hora, tipoFalta: tipoFinal, descripcion, accion, createdAt: new Date().toISOString() };
      await addDoc(collection(db, "fichas"), fichaData);

      const studentRef = doc(db, "students", nie);
      await updateDoc(studentRef, { fichas: currentStudent.fichas + 1 });
      currentStudent.fichas += 1;

      alert("Ficha registrada exitosamente.");
      showDownloadButton();
    });

    // Cancelar formularios
    cancelarRegistroBtn.addEventListener("click", resetForms);
    cancelarFichaBtn.addEventListener("click", resetForms);

    function resetForms() {
      nuevoEstudianteForm.classList.add("hidden");
      agregarFichaForm.classList.add("hidden");
      descargarFichaBtnContainer.classList.add("hidden");
      accionesExistente.classList.add("hidden");
      opcionesStudent.classList.add("hidden");
    }

    function showDownloadButton() {
      descargarFichaBtnContainer.classList.remove("hidden");
    }

    // Descargar PDF
    descargarFichaBtn.addEventListener("click", () => {
      generatePDF(currentStudent);
    });

    function generatePDF(student) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("FICHA ESCOLAR", 10, 20);
      doc.setFontSize(12);
      doc.text("CENTRO ESCOLAR CANTÓN LOS PRADOS", 10, 30);

      // Datos
      const y = 40;
      doc.text(`Nombre del Estudiante: ${student.nombre}`, 10, y);
      doc.text(`Grado: ${student.grado}`, 100, y);
      doc.text(`NIE: ${student.nie}`, 10, y + 10);
      doc.text(`Número de Fichas Acumuladas: ${student.fichas}`, 10, y + 20);

      // Falta
      doc.text(`Fecha: ___________________ Hora: ___________________`, 10, y + 35);
      doc.text(`Tipo de Falta Cometida:`, 10, y + 50);
      doc.text(`___ Académica ___ Conducta ___ Puntualidad ___ Otra: ________________`, 10, y + 60);
      doc.text(`Descripción de la Falta:`, 10, y + 75);
      doc.text(`_______________________________________________________`, 10, y + 85);
      doc.text(`Acción tomada: _____________________________________________`, 10, y + 100);

      // Firmas
      doc.text(`Firma del Estudiante: __________________________`, 10, y + 120);
      doc.text(`Firma del Responsable: _________________________`, 10, y + 135);
      doc.text(`Firma del Docente: _____________________________`, 100, y + 135);

      doc.save(`ficha_${student.nombre.replace(/\s+/g, '_')}.pdf`);
    }

    // Cargar Consolidado
    async function loadConsolidado() {
      const estudiantesDiv = document.getElementById("lista-estudiantes");
      estudiantesDiv.innerHTML = "<p>Cargando estudiantes...</p>";

      try {
        const querySnapshot = await getDocs(collection(db, "students"));
        const estudiantes = [];

        querySnapshot.forEach((doc) => {
          estudiantes.push({ ...doc.data(), id: doc.id });
        });

        estudiantes.sort((a, b) => a.nombre.localeCompare(b.nombre));

        if (estudiantes.length === 0) {
          estudiantesDiv.innerHTML = "<p>No hay estudiantes registrados.</p>";
          return;
        }

        estudiantesDiv.innerHTML = "";
        estudiantes.forEach(estudiante => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <strong>${estudiante.nombre}</strong> 
            <span style="float:right;">Fichas: ${estudiante.fichas || 0}</span>
          `;
          card.style.cursor = "pointer";
          card.onclick = () => showDetalles(estudiante);
          estudiantesDiv.appendChild(card);
        });
      } catch (error) {
        estudiantesDiv.innerHTML = "<p>Error al cargar estudiantes.</p>";
      }
    }

    function showDetalles(estudiante) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.style.display = "flex";

      const content = document.createElement("div");
      content.className = "modal-content";
      content.style.width = "90%";
      content.style.maxWidth = "600px";
      content.style.maxHeight = "80vh";
      content.style.overflowY = "auto";

      content.innerHTML = `
        <h3>Fichas de ${estudiante.nombre}</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Acción</th>
              <th>PDF</th>
            </tr>
          </thead>
          <tbody id="fichas-body"></tbody>
        </table>
        <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;">Cerrar</button>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Cargar fichas
      getDocs(collection(db, "fichas").where("nie", "==", estudiante.id))
        .then(snapshot => {
          const tbody = content.querySelector("#fichas-body");
          if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='4'>No hay fichas registradas.</td></tr>";
          } else {
            snapshot.forEach(doc => {
              const f = doc.data();
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${f.fecha}</td>
                <td>${f.tipoFalta}</td>
                <td>${f.accion}</td>
                <td>
                  <button onclick="generatePDFFromConsolidado(${JSON.stringify({...f, nombre: estudiante.nombre, fichas: estudiante.fichas}).replace(/"/g, '&quot;')})">
                    <i class="fas fa-download"></i>
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
        });
    }

    // Función global para PDF desde consolidado
    window.generatePDFFromConsolidado = function(fichaData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("FICHA ESCOLAR", 10, 20);
      doc.setFontSize(12);
      doc.text("CENTRO ESCOLAR CANTÓN LOS PRADOS", 10, 30);

      const y = 40;
      doc.text(`Nombre del Estudiante: ${fichaData.nombre}`, 10, y);
      doc.text(`Grado: ___________`, 100, y);
      doc.text(`NIE: ${fichaData.nie || '___________'}`, 10, y + 10);
      doc.text(`Número de Fichas Acumuladas: ${fichaData.fichas}`, 10, y + 20);

      doc.text(`Fecha: ${fichaData.fecha} Hora: ${fichaData.hora}`, 10, y + 35);
      doc.text(`Tipo de Falta: ${fichaData.tipoFalta}`, 10, y + 50);
      doc.text(`Descripción: ${fichaData.descripcion}`, 10, y + 65);
      doc.text(`Acción tomada: ${fichaData.accion}`, 10, y + 80);

      doc.text(`Firma del Estudiante: __________________________`, 10, y + 100);
      doc.text(`Firma del Responsable: _________________________`, 10, y + 115);
      doc.text(`Firma del Docente: _____________________________`, 100, y + 115);

      doc.save(`ficha_${fichaData.nombre.replace(/\s+/g, '_')}_${fichaData.fecha}.pdf`);
    };

    // Cargar jsPDF
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
    script.onload = () => console.log("jsPDF cargado");
    document.head.appendChild(script);
  </script>
</body>
</html>
